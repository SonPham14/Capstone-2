import sys, json, os, datetime
from pathlib import Path

# active-responses.log
LOG_FILE = Path(os.getenv('ProgramFiles(x86)', r'C:\Program Files (x86)')) \
           / 'ossec-agent' / 'active-response' / 'active-responses.log'

def log(msg):
    LOG_FILE.parent.mkdir(parents=True, exist_ok=True)
    with open(LOG_FILE, "a") as f:
        f.write(f"{datetime.datetime.now():%Y/%m/%d %H:%M:%S} {msg}\n")

def main():
    # Readline JSON
    raw = sys.stdin.readline()
    try:
        data = json.loads(raw)
    except Exception as e:
        log(f"Invalid JSON: {e}")
        return

    log(f"Payload: {data}")

    # Chạy khi action = add
    action = data.get("command")
    if action != "add":
        log(f"Non-add action '{action}', skipping")
        return

    # Lấy file path từ extra_args
    args = data.get("parameters", {}).get("extra_args", [])
    if not args:
        log("No target file in extra_args")
        return
    target = args[0]

    # Xóa file
    if os.path.exists(target):
        try:
            os.remove(target)
            log(f"Deleted file: {target}")
        except Exception as e:
            log(f"Error deleting '{target}': {e}")
    else:
        log(f"File not found: {target}")

if __name__ == "__main__":
    main()
